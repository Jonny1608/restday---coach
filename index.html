<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Rest-Day Coach</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#ffffff; --muted:#64748b; --border:#e5e7eb; --brand:#4f46e5; --brand-50:#eef2ff;
      --text:#0f172a; --chip:#f1f5f9; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    h1{font-size:26px;margin:0}
    .sub{color:var(--muted)}
    .tabs{display:flex;gap:6px;margin:10px 0 14px}
    .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:#fff;color:#111}
    .tab.active{background:var(--brand);border-color:var(--brand);color:#fff}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .mantra{background:var(--brand-50);color:#3730a3;padding:10px;border-radius:12px;margin:10px 0}
    .grid2{display:grid;grid-template-columns:1fr;gap:12px}
    .grid3{display:grid;grid-template-columns:1fr;gap:8px}
    .grid4{display:grid;grid-template-columns:1fr;gap:8px}
    .weekgrid{display:grid;grid-template-columns:1fr;gap:8px}
    @media (min-width:780px){
      .grid2{grid-template-columns:1fr 1fr}
      .grid3{grid-template-columns:repeat(3,1fr)}
      .grid4{grid-template-columns:repeat(4,1fr)}
      .weekgrid{grid-template-columns:repeat(7,1fr)}
    }
    .toolbar{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)} .small{font-size:12px}
    .chip{background:var(--chip);padding:6px 8px;border-radius:8px;display:inline-block}
    button,select,input,textarea{font:inherit} 
    button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    button.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    input[type="text"],input[type="number"],textarea,select{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff}
    textarea{min-height:90px;resize:vertical}
    .dayhead{font-size:12px;color:var(--muted)}
    .title{font-weight:650}
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 8px;background:#f8fafc;border:1px solid var(--border)}
    .emoji{font-size:18px}
    .bar{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .bar > span{display:block;height:100%;background:linear-gradient(90deg,#4f46e5,#22c55e)}
  </style>
  <!-- React + Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const {useMemo,useState,useEffect} = React;

/* ===== Helpers & Data ===== */
const today = () => new Date();
const startOfWeek = (d) => { const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x; };
const fmt = (d) => d.toLocaleDateString("de-AT",{day:"2-digit",month:"2-digit"});
const weekday = (d) => d.toLocaleDateString("de-AT",{weekday:"short"});

const BLOCKS = [
  { name:"Einstieg", type:"einstieg", start:"2025-09-01", end:"2025-09-07" },
  { name:"Aufbau I", type:"aufbau",  start:"2025-09-08", end:"2025-09-28" },
  { name:"Deload",   type:"deload",  start:"2025-09-29", end:"2025-10-05" },
  { name:"Aufbau II",type:"aufbau",  start:"2025-10-06", end:"2025-10-26" },
  { name:"Deload",   type:"deload",  start:"2025-10-27", end:"2025-11-02" },
  { name:"Aufbau III",type:"aufbau", start:"2025-11-03", end:"2025-12-14" },
  { name:"Deload",   type:"deload",  start:"2025-12-15", end:"2025-12-21" },
];

const MANTRAS = [
  "Konstanz schlÃ¤gt Perfektion.",
  "StÃ¤rke wÃ¤chst aus Technik + Geduld.",
  "Locker ist schnell â€“ und sauber.",
  "Jeder Meter zÃ¤hlt â€“ heute sinnvoll, morgen stÃ¤rker.",
  "Progress, not punishment.",
  "Atmen, sauber bewegen, ankommen.",
  "Training = Reiz Â· (Erholung)^2."
];

const DINNERS = [
  { name:"SÃ¼ÃŸkartoffel-Linsen-Suppe", tag:"70/30" },
  { name:"Hirse-Tabouleh", tag:"70/30" },
  { name:"Kartoffel-Erbsen-Suppe", tag:"70/30" },
  { name:"Polenta mit Pilzen", tag:"70/30" },
  { name:"Veggie-Chili", tag:"Aufbau" },
  { name:"OfengemÃ¼se + Kichererbsen-Bowl", tag:"Aufbau" },
];

const TPL = {
  aufbau: [
    { day:1, type:"kraft",    title:"Kraft: Squat + Bank", desc:"" },
    { day:2, type:"ausdauer", title:"Ausdauer locker",    desc:"30â€“45 Min" },
    { day:3, type:"crossfit", title:"CrossFit",           desc:"All-out + 10â€™ Mobility" },
    { day:4, type:"rest",     title:"Active Recovery",    desc:"Spaziergang + 15â€™ Mobility" },
    { day:5, type:"kraft",    title:"Kraft: Deadlift + Press", desc:"" },
    { day:6, type:"ausdauer", title:"Ausdauer mittel/lang", desc:"10 km / 60â€“70â€™" },
    { day:7, type:"rest",     title:"Rest", desc:"Spaziergang/Kinderwagen" },
  ],
  einstieg: [
    { day:1, type:"kraft", title:"Kraft (leicht)", desc:"Squat + Bank Technik" },
    { day:2, type:"ausdauer", title:"Lauf locker", desc:"30â€“40â€™" },
    { day:3, type:"crossfit", title:"CrossFit (Technik)", desc:"~70%" },
    { day:4, type:"rest", title:"Active Recovery", desc:"+ 15â€™ Mobility" },
    { day:5, type:"kraft", title:"Kraft (leicht)", desc:"Deadlift + Press Technik" },
    { day:6, type:"ausdauer", title:"Rad locker", desc:"45â€™ / Spaziergang" },
    { day:7, type:"rest", title:"Rest", desc:"Entlasten" },
  ],
  deload: [
    { day:1, type:"kraft", title:"Kraft leicht", desc:"-40% Â· Technik" },
    { day:2, type:"ausdauer", title:"Rad/Lauf EASY", desc:"30â€™" },
    { day:3, type:"rest", title:"Mobility/Technik", desc:"kein CrossFit" },
    { day:4, type:"rest", title:"Rest Day", desc:"" },
    { day:5, type:"kraft", title:"Kraft leicht", desc:"-40% Â· Technik" },
    { day:6, type:"ausdauer", title:"Lauf locker", desc:"30â€“40â€™" },
    { day:7, type:"rest", title:"Rest Day", desc:"" },
  ],
};

const useStored = (key, initial) => {
  const [v,setV] = useState(()=>{ try{const r=localStorage.getItem(key);return r?JSON.parse(r):initial}catch{return initial} });
  useEffect(()=>{ try{localStorage.setItem(key,JSON.stringify(v))}catch{} },[key,v]);
  return [v,setV];
};

const getBlock = (d) => BLOCKS.find(b => d >= new Date(b.start) && d <= new Date(b.end)) || {name:"Plan",type:"aufbau"};

function App(){
  const [tab,setTab] = useStored("tab","today");
  const [weekStart, setWeekStart] = useStored("weekStart", startOfWeek(today()).toISOString());
  const [custom, setCustom] = useStored("custom", {}); // dateKey -> {type,title,desc}
  const [check, setCheck]   = useStored("check", {});  // checklist
  const [notes, setNotes]   = useStored("notes", "");  // freie Notiz
  const [journal, setJournal]= useStored("journal", {}); // dateKey -> {reflexion,planung,dank}

  const wStart = new Date(weekStart);
  const block = getBlock(wStart);
  const tpl = TPL[block.type];

  const days = useMemo(()=> Array.from({length:7},(_,i)=> new Date(wStart.getTime()+i*86400000)),[weekStart]);
  const plan = days.map(d=>{
    const dow=((d.getDay()+6)%7)+1;
    const key=d.toISOString().slice(0,10);
    const base=tpl.find(x=>x.day===dow);
    const c=custom[key]||{};
    const type = c.type ?? base.type;
    const title= c.title?? base.title;
    const desc = c.desc ?? base.desc;
    const isRest = type==="rest" || /Rest/i.test(title);
    return {date:d,key,type,title,desc,isRest};
  });

  const isToday=(d)=> today().toDateString()===d.toDateString();
  const mantra = MANTRAS[((Math.floor((today()-new Date("2025-01-01"))/86400000)%MANTRAS.length)+MANTRAS.length)%MANTRAS.length];

  const dinnerFor = (d) => {
    const b=getBlock(d);
    const pool=b.type==="deload"? DINNERS.filter(x=>x.tag==="70/30") : DINNERS;
    const idx=Math.abs(Math.floor((d - new Date("2025-01-01"))/86400000))%pool.length;
    return pool[idx]?.name || "GemÃ¼se-Bowl";
  };

  // Journaling Pools
  const Q_REFLEX = [
    "Was hat mir Training heute Ã¼ber mich gezeigt?",
    "Wo war ich technisch sauber â€“ und warum?",
    "Was hat Energie gegeben, was genommen?"
  ];
  const Q_PLAN = [
    "Was ist morgen realistisch + sinnvoll?",
    "Welcher Reiz ist morgen dran (leicht/mittel/hart)?",
    "Was plane ich fÃ¼r Schlaf & Essen?"
  ];
  const Q_DANK = [
    "WofÃ¼r bin ich heute dankbar?",
    "Wer/was hat mich unterstÃ¼tzt?",
    "Welcher kleine Moment war schÃ¶n?"
  ];
  const pick3 = () => ({
    reflex: Q_REFLEX[Math.floor(Math.random()*Q_REFLEX.length)],
    plan:   Q_PLAN[Math.floor(Math.random()*Q_PLAN.length)],
    dank:   Q_DANK[Math.floor(Math.random()*Q_DANK.length)],
  });
  const [prompts,setPrompts] = useState(pick3());

  // Update helpers keep existing fields
  const setType = (key,value,fallbackTitle,fallbackDesc) =>
    setCustom(prev => ({...prev,[key]:{title:prev[key]?.title??fallbackTitle, desc:prev[key]?.desc??fallbackDesc, type:value}}));
  const setTitle= (key,value,fallbackType,fallbackDesc) =>
    setCustom(prev => ({...prev,[key]:{type:prev[key]?.type??fallbackType, desc:prev[key]?.desc??fallbackDesc, title:value}}));
  const setDesc = (key,value,fallbackType,fallbackTitle) =>
    setCustom(prev => ({...prev,[key]:{type:prev[key]?.type??fallbackType, title:prev[key]?.title??fallbackTitle, desc:value}}));

  // History (last 30 days)
  const allKeys = useMemo(()=> Object.keys(custom).concat(plan.map(p=>p.key)).filter((v,i,a)=>a.indexOf(v)===i).sort(),[custom,plan]);
  const last30 = useMemo(()=>{
    const now=today();
    return allKeys
      .map(k=>({k, d:new Date(k)}))
      .filter(x=> (now - x.d) <= 30*86400000)
      .map(({k,d})=>{
        const p = plan.find(p=>p.key===k) || {};
        const c = custom[k]||{};
        return { date:d, key:k, type:c.type??p.type, title:c.title??p.title, desc:c.desc??p.desc };
      })
      .sort((a,b)=> b.date - a.date);
  },[allKeys,plan,custom]);

  const stats = useMemo(()=>{
    const counts={ausdauer:0,kraft:0,crossfit:0,rest:0};
    last30.forEach(x=>{ if(counts[x.type]!=null) counts[x.type]++; });
    const total = last30.length || 1;
    const pct = Object.fromEntries(Object.entries(counts).map(([k,v])=>[k, Math.round(100*v/total)]));
    return {counts,pct,total};
  },[last30]);

  return (
    <div className="container">
      <header>
        <div>
          <h1>Rest-Day Coach</h1>
          <div className="sub">Block: <b>{block.name}</b></div>
        </div>
        <nav className="tabs" role="tablist">
          <button className={`tab ${tab==='today'?'active':''}`} onClick={()=>setTab('today')}>Heute</button>
          <button className={`tab ${tab==='week'?'active':''}`} onClick={()=>setTab('week')}>Woche</button>
          <button className={`tab ${tab==='history'?'active':''}`} onClick={()=>setTab('history')}>Historie</button>
        </nav>
      </header>

      {/* ========= TAB: TODAY ========= */}
      {tab==='today' && (
        <>
          <div className="mantra"><b>Mantra:</b> {mantra}</div>

          <div className="grid2">
            {/* Tageskarte */}
            <div className="card">
              <div className="title" style={{marginBottom:8}}>ğŸ“Œ Tageskarte</div>
              {plan.map(d=> isToday(d.date) ? (
                <div key={d.key}>
                  <div className="chip">Datum: {weekday(d.date)} Â· {fmt(d.date)}</div>
                  <div style={{marginTop:8}}><b>Typ:</b> {d.type==='kraft'?'Kraft':d.type==='ausdauer'?'Ausdauer':d.type==='crossfit'?'CrossFit':'Rest'}</div>
                  <div><b>Titel:</b> {d.title}</div>
                  {d.desc && <div><b>Details:</b> {d.desc}</div>}
                  <div style={{marginTop:8}}><b>Abendessen-Idee:</b> {dinnerFor(d.date)}</div>
                </div>
              ):null)}
              {!plan.some(d=>isToday(d.date)) && <div className="muted small">Kein Tagesplan gefunden.</div>}
            </div>

            {/* Checkliste + Journaling */}
            <div className="card">
              <div className="title" style={{marginBottom:8}}>âœ… Checkliste & Journaling</div>
              {plan.map(d=> isToday(d.date) ? (
                <div key={d.key}>
                  <div className="grid4">
                    {["train","dinner","rest","water","sleep"].map(k=>(
                      <label key={k} className="chip" style={{display:"flex",gap:8,alignItems:"center"}}>
                        <input type="checkbox"
                          checked={!!check[d.key]?.[k]}
                          onChange={e=> setCheck(prev=>({ ...prev, [d.key]: { ...(prev[d.key]||{}), [k]: e.target.checked } }))}
                        />
                        {k==="train"?"Training":k==="dinner"?"Essen 70/30":k==="rest"?"Rest/Active":k==="water"?"2L Wasser":"7h Schlaf"}
                      </label>
                    ))}
                  </div>

                  <div className="grid3" style={{marginTop:12}}>
                    <div>
                      <div className="small muted">Reflexion</div>
                      <textarea placeholder={prompts.reflex}
                        value={journal[d.key]?.reflexion||""}
                        onChange={e=> setJournal(prev=>({...prev,[d.key]:{...(prev[d.key]||{}), reflexion:e.target.value}}))}
                      ></textarea>
                    </div>
                    <div>
                      <div className="small muted">Tagesplanung</div>
                      <textarea placeholder={prompts.plan}
                        value={journal[d.key]?.planung||""}
                        onChange={e=> setJournal(prev=>({...prev,[d.key]:{...(prev[d.key]||{}), planung:e.target.value}}))}
                      ></textarea>
                    </div>
                    <div>
                      <div className="small muted">Dankbarkeit</div>
                      <textarea placeholder={prompts.dank}
                        value={journal[d.key]?.dank||""}
                        onChange={e=> setJournal(prev=>({...prev,[d.key]:{...(prev[d.key]||{}), dank:e.target.value}}))}
                      ></textarea>
                    </div>
                  </div>
                  <div style={{marginTop:8}}>
                    <button onClick={()=>setPrompts(pick3())}>Neue Fragen</button>
                  </div>
                </div>
              ):null)}
            </div>
          </div>
        </>
      )}

      {/* ========= TAB: WEEK ========= */}
      {tab==='week' && (
        <div className="card">
          <div className="toolbar">
            <div className="title">ğŸ“… Kalenderwoche â€“ {fmt(new Date(wStart))} â€“ {fmt(new Date(wStart.getTime()+6*86400000))}</div>
            <div style={{display:"flex",gap:6}}>
              <button onClick={()=>setWeekStart(new Date(wStart.getTime()-7*86400000).toISOString())}>Â«</button>
              <button className="primary" onClick={()=>setWeekStart(startOfWeek(today()).toISOString())}>Diese Woche</button>
              <button onClick={()=>setWeekStart(new Date(wStart.getTime()+7*86400000).toISOString())}>Â»</button>
            </div>
          </div>

          <div className="weekgrid" style={{marginTop:10}}>
            {plan.map(d=>(
              <div key={d.key} className="card" style={{padding:10}}>
                <div className="dayhead">{weekday(d.date)} Â· {fmt(d.date)}</div>

                <div className="small muted" style={{marginTop:6}}>Typ</div>
                <select value={d.type} onChange={e=> setType(d.key,e.target.value,d.title,d.desc)}>
                  <option value="ausdauer">ğŸƒ Ausdauer</option>
                  <option value="kraft">ğŸ’ª Kraft</option>
                  <option value="crossfit">ğŸ”¥ CrossFit</option>
                  <option value="rest">ğŸ›Œ Rest / Active</option>
                </select>

                <div className="small muted" style={{marginTop:8}}>Titel</div>
                <input type="text" value={d.title} onChange={e=> setTitle(d.key,e.target.value,d.type,d.desc)} placeholder="z. B. Laufen, Kraft Tag A"/>

                <div className="small muted" style={{marginTop:8}}>Beschreibung (Dauer, km, RPE â€¦)</div>
                <input type="text" value={d.desc} onChange={e=> setDesc(d.key,e.target.value,d.type,d.title)} placeholder="z. B. 7 km Â· 45â€™ Â· RPE 6/10"/>
              </div>
            ))}
          </div>

          <div className="grid2" style={{marginTop:12}}>
            <div className="card">
              <div className="title">ğŸ—’ï¸ Wochen-Notiz</div>
              <textarea placeholder="Gedanken zur Wocheâ€¦" value={notes} onChange={(e)=>setNotes(e.target.value)}></textarea>
            </div>
            <div className="card">
              <div className="title">ğŸ½ï¸ 70/30-Abendessen-Ideen</div>
              <div className="grid3" style={{marginTop:8}}>
                {DINNERS.map((d,i)=>(
                  <div key={i} className="chip">{d.name}</div>
                ))}
              </div>
              <div className="small muted" style={{marginTop:6}}>In Deload-Wochen werden automatisch bevorzugt 70/30-Ideen angezeigt.</div>
            </div>
          </div>
        </div>
      )}

      {/* ========= TAB: HISTORY ========= */}
      {tab==='history' && (
        <div className="card">
          <div className="title">ğŸ“ˆ Historie (letzte 30 Tage)</div>
          <div className="grid3" style={{marginTop:10}}>
            <div className="card"><div className="small muted">Ausdauer</div><div className="title">{stats.counts.ausdauer}</div></div>
            <div className="card"><div className="small muted">Kraft</div><div className="title">{stats.counts.kraft}</div></div>
            <div className="card"><div className="small muted">CrossFit</div><div className="title">{stats.counts.crossfit}</div></div>
          </div>

          <div style={{marginTop:10}}>
            <div className="small muted">Verteilung</div>
            <div className="bar"><span style={{width:`${Math.min(100,stats.pct.ausdauer+stats.pct.kraft+stats.pct.crossfit)}%`}}></span></div>
            <div className="small muted" style={{display:"flex",gap:12,marginTop:6}}>
              <span>ğŸƒ {stats.pct.ausdauer}%</span>
              <span>ğŸ’ª {stats.pct.kraft}%</span>
              <span>ğŸ”¥ {stats.pct.crossfit}%</span>
              <span>ğŸ›Œ {stats.counts.rest} Rest-Tage</span>
            </div>
          </div>

          <div className="grid2" style={{marginTop:12}}>
            <div>
              <div className="small muted">Filter</div>
              <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:6}}>
                {["alle","ausdauer","kraft","crossfit","rest"].map(f=>(
                  <button key={f} className={`chip`} onClick={()=>setTab(`history-${f}`)}>{f}</button>
                ))}
              </div>
            </div>
          </div>

          <div style={{marginTop:10}}>
            {(tab.startsWith("history-")? last30.filter(x=> tab==="history-alle" ? true : x.type===tab.replace("history-","")) : last30)
              .map(x=>(
              <div key={x.key} className="card" style={{padding:10, marginTop:8}}>
                <div className="dayhead">{weekday(x.date)} Â· {fmt(x.date)}</div>
                <div className="title" style={{marginTop:4}}>
                  {x.type==="ausdauer"?"ğŸƒ":x.type==="kraft"?"ğŸ’ª":x.type==="crossfit"?"ğŸ”¥":"ğŸ›Œ"} {x.title||"(ohne Titel)"}
                </div>
                {x.desc && <div className="muted">{x.desc}</div>}
              </div>
            ))}
            {last30.length===0 && <div className="muted small">Noch keine EintrÃ¤ge in den let
